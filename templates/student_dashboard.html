{% extends "base.html" %}

{% block title %}Student Dashboard - Edu-Ride{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-user-graduate me-2"></i>Student Dashboard</h2>
                <div class="text-muted">Welcome, {{ current_user.username }}!</div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-route me-2"></i>Available Rides</h5>
                </div>
                <div class="card-body">
                    {% if rides %}
                        <div class="row" id="rides-container">
                            {% for ride in rides %}
                            <div class="col-md-6 mb-3">
                                <div class="card border">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title mb-0">{{ ride.pickup_location }} → {{ ride.dropoff_location }}</h6>
                                            <span class="badge bg-primary">₹{{ ride.fare }}</span>
                                        </div>
                                        <p class="card-text text-muted small mb-2">
                                            <i class="fas fa-clock me-1"></i>{{ ride.pickup_time.strftime('%H:%M, %d %b %Y') }}
                                        </p>
                                        <p class="card-text text-muted small mb-2">
                                            <i class="fas fa-user me-1"></i>Driver: {{ ride.driver.username }}
                                        </p>
                                        {% if ride.is_group_ride %}
                                        <p class="card-text text-muted small mb-3">
                                            <i class="fas fa-users me-1"></i>Group Ride: {{ ride.current_passengers }}/{{ ride.max_passengers }} passengers
                                        </p>
                                        {% endif %}
                                        <button class="btn btn-primary btn-sm" onclick="bookRide({{ ride.id }})">
                                            <i class="fas fa-bookmark me-1"></i>Book Ride
                                        </button>
                                        <a href="{{ url_for('track_ride', ride_id=ride.id) }}" class="btn btn-info btn-sm ms-1">
                                            <i class="fas fa-map-marked-alt me-1"></i>Track
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-search text-muted display-4 mb-3"></i>
                            <h5 class="text-muted">No rides available at the moment</h5>
                            <p class="text-muted">Check back later for new ride offers</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-bell me-2"></i>Notifications</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadNotifications()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-body" id="notifications-container">
                    <div class="text-center">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Quick Info</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Total Rides:</span>
                        <span class="fw-bold">{{ current_user.student_rides|length }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Group Rides:</span>
                        <span class="fw-bold">{{ current_user.group_rides|length }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Total Saved:</span>
                        <span class="fw-bold text-success">₹0</span>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Tips</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Book group rides to save money</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Check ride availability regularly</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Use UPI for quick payments</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function bookRide(rideId) {
    if (confirm('Are you sure you want to book this ride?')) {
        fetch('/api/book_ride', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                ride_id: rideId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Ride booked successfully!');
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while booking the ride');
        });
    }
}

// Auto-refresh rides every 30 seconds
setInterval(function() {
    fetch('/api/rides')
        .then(response => response.json())
        .then(data => {
            // Update the rides display
            updateRidesDisplay(data);
        })
        .catch(error => {
            console.error('Error fetching rides:', error);
        });
}, 30000);

function updateRidesDisplay(rides) {
    const container = document.getElementById('rides-container');
    if (rides.length === 0) {
        container.innerHTML = `
            <div class="col-12">
                <div class="text-center py-4">
                    <i class="fas fa-search text-muted display-4 mb-3"></i>
                    <h5 class="text-muted">No rides available at the moment</h5>
                    <p class="text-muted">Check back later for new ride offers</p>
                </div>
            </div>
        `;
    } else {
        container.innerHTML = rides.map(ride => `
            <div class="col-md-6 mb-3">
                <div class="card border">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0">${ride.pickup_location} → ${ride.dropoff_location}</h6>
                            <span class="badge bg-primary">₹${ride.fare}</span>
                        </div>
                        <p class="card-text text-muted small mb-2">
                            <i class="fas fa-clock me-1"></i>${new Date(ride.pickup_time).toLocaleString()}
                        </p>
                        <p class="card-text text-muted small mb-2">
                            <i class="fas fa-user me-1"></i>Driver: ${ride.driver_name}
                        </p>
                        ${ride.is_group_ride ? `
                        <p class="card-text text-muted small mb-3">
                            <i class="fas fa-users me-1"></i>Group Ride: ${ride.current_passengers}/${ride.max_passengers} passengers
                        </p>
                        ` : ''}
                        <button class="btn btn-primary btn-sm" onclick="bookRide(${ride.id})">
                            <i class="fas fa-bookmark me-1"></i>Book Ride
                        </button>
                        <a href="/track_ride/${ride.id}" class="btn btn-info btn-sm ms-1">
                            <i class="fas fa-map-marked-alt me-1"></i>Track
                        </a>
                    </div>
                </div>
            </div>
        `).join('');
    }
}

// Load notifications
async function loadNotifications() {
    try {
        const response = await fetch('/api/notifications');
        const notifications = await response.json();
        
        const container = document.getElementById('notifications-container');
        if (notifications.length === 0) {
            container.innerHTML = '<div class="text-muted text-center">No notifications</div>';
        } else {
            container.innerHTML = notifications.map(notif => `
                <div class="alert alert-${notif.type} alert-sm mb-2">
                    <div class="small">${notif.message}</div>
                    <div class="text-muted" style="font-size: 0.75rem;">${new Date(notif.timestamp).toLocaleString()}</div>
                </div>
            `).join('');
        }
    } catch (error) {
        console.error('Error loading notifications:', error);
        document.getElementById('notifications-container').innerHTML = '<div class="text-danger text-center">Failed to load notifications</div>';
    }
}

// Initialize real-time updates on dashboard pages
if (window.location.pathname.includes('dashboard')) {
    document.addEventListener('DOMContentLoaded', function() {
        startRealTimeUpdates();
        loadNotifications();
    });
}
</script>
{% endblock %}
